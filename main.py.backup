"""
Slappy Bot - Entry Point
Convertito da workflow n8n SLAPPY_v47_LOCK
"""
import logging
import sys
from telegram import Update
from telegram.ext import Application, MessageHandler, CallbackQueryHandler, CommandHandler, filters

from config import TELEGRAM_BOT_TOKEN, WEBHOOK_URL, PORT, LOG_LEVEL
from handlers import handle_update

# Configurazione logging JSON
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=getattr(logging, LOG_LEVEL.upper(), logging.INFO),
    handlers=[logging.StreamHandler(sys.stdout)]
)
logger = logging.getLogger(__name__)


async def start_handler(update: Update, context):
    """Handler per comando /start"""
    await handle_update(update, context)


async def message_handler(update: Update, context):
    """Handler per messaggi di testo"""
    await handle_update(update, context)


async def callback_handler(update: Update, context):
    """Handler per callback query (bottoni)"""
    await handle_update(update, context)


def main():
    """Avvia il bot"""
    if not TELEGRAM_BOT_TOKEN:
        logger.error("TELEGRAM_BOT_TOKEN non configurato!")
        sys.exit(1)

    logger.info("Avvio Slappy Bot...")

    # Crea applicazione
    application = Application.builder().token(TELEGRAM_BOT_TOKEN).build()

    # Registra handlers
    application.add_handler(CommandHandler("start", start_handler))
    application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, message_handler))
    application.add_handler(CallbackQueryHandler(callback_handler))

    # Modalità webhook (produzione) o polling (sviluppo)
    if WEBHOOK_URL:
        logger.info(f"Avvio in modalità WEBHOOK su porta {PORT}")
        application.run_webhook(
            listen="0.0.0.0",
            port=PORT,
            url_path=TELEGRAM_BOT_TOKEN,
            webhook_url=f"{WEBHOOK_URL}/{TELEGRAM_BOT_TOKEN}"
        )
    else:
        logger.info("Avvio in modalità POLLING (sviluppo)")
        application.run_polling(allowed_updates=Update.ALL_TYPES)


if __name__ == "__main__":
    main()
